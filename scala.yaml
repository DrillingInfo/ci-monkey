- property:
    name: prop-macro
    properties:
      - github:
          url: https://@url@/@group@/@repo@/
- scm:
    name: scm-macro
    scm:
      - git:
          url: ssh://git@@url@/@group@/@repo@.git
          branches:
            - '{branch}'
          refspec: '{refspec}'
          included-regions:
            - '{included}'
          excluded-regions:
            - '{excluded}'
          wipe-workspace: true
          browser: githubweb
          browser-url: https://@url@/@group@/@repo@/
          git-tool: System Default Git
- trigger:
    name: pull-request-trigger
    triggers:
      - github-pull-request:
          admin-list:
            - @user1@
            - @user2@
          org-list:
            - @group@
          cron: '* * * * *'
- trigger:
    name: main-trigger
    triggers:
      - github
      - pollscm: ''
- builder:
    name: builder-macro
    builders:
      - shell: sbt -sbt-launch-dir /jenkins/sbt-launchers "{task}"
- builder:
    name: comment-pr-macro
    builders:
      - shell: |
               #!/bin/bash
               set -ex
               group=@group@
               repo=@repo@
               mpr=`git log -1 | grep -oe "Merge pull request #[0-9]*" | { grep -oe [0-9]* || true; }`
               #find out if the pull request has already been commented
               commented=`curl -k -H "Authorization: token @token@" https://@apiUrl@/repos/$group/$repo/issues/$mpr/comments | { grep "$JOB_NAME number [0-9]* integrated pull request" || true; }`
               if [[ -z $commented ]]; then
                 #Comment on pull request the build it was integrated in
                 if [[ -n "$mpr" ]]; then
                   curl -k -H "Authorization: token @token@" -d "{\"body\":\"$JOB_NAME number $BUILD_NUMBER integrated pull request #$mpr.  For details see: $BUILD_URL\"}" -X POST https://@apiUrl@/repos/$group/$repo/issues/$mpr/comments
                 fi
               fi
- publisher:
    name: pub-macro
    publishers:
      - jacoco:
          exec-pattern: "**/target/scala-2.10/jacoco/**.exec"
          class-pattern: "**/target/scala-2.10/classes"
          source-pattern: "**/app"
          status-update: true
          targets:
            - branch:
                health: 10
                unhealthy: 20
            - method:
                healthy: 50
                unhealthy: 40
- publisher:
    name: test-result-macro
    publishers:
      - junit:
          results: target/test-reports/*.xml
- wrapper:
    name: wrapper-macro
    wrappers:
      - inject:
          script-content: echo REAL_BRANCH=`git rev-parse HEAD | git branch --contains | grep -E -v '^(\*)'`>branch.prop
      - build-name:
          name: ${PROPFILE,file="branch.prop",property="REAL_BRANCH"}-#$BUILD_NUMBER
- wrapper:
    name: ansicolor-macro
    wrappers:
      - ansicolor
- job:
    name: @repo@-build
    description: Build @repo@
    project-type: freestyle
    node: sbt
    logrotate:
        daysToKeep: -1
        numToKeep: 30
        artifactDaysToKeep: 30
        artifactNumToKeep: -1
    properties:
      - prop-macro
    scm:
      - scm-macro:
          branch: "master"
          refspec: +refs/heads/*:refs/remotes/origin/*
          included: ''
          excluded: 'jenkins/.*'
          local-branch: dev
    triggers:
      - main-trigger
    builders:
      - builder-macro:
          task: test
      - builder-macro:
          task: jacoco:cover
      - builder-macro:
          task: universal:aetherDeploy
      - comment-pr-macro
    publishers:
      - pub-macro
      - test-result-macro
    wrappers:
      - wrapper-macro
      - ansicolor-macro
- job:
    name: @repo@-release
    description: Release @repo@
    project-type: freestyle
    node: sbt
    logrotate:
        daysToKeep: -1
        numToKeep: 30
        artifactDaysToKeep: 30
        artifactNumToKeep: -1
    properties:
      - prop-macro
    parameters:
      - string:
          description: What branch should be released?
          name: release_branch
          default: dev
    scm:
      - scm-macro:
          branch: '${release_branch}'
          refspec: +refs/heads/*:refs/remotes/origin/*
          included: ''
          excluded: 'jenkins/.*'
          local-branch: "dev"
    builders:
      - shell: git branch --set-upstream ${release_branch} origin/${release_branch}
      - builder-macro:
          task: "release with-defaults"
      - comment-pr-macro
    wrappers:
      - wrapper-macro
      - ansicolor-macro
    publishers:
      - test-result-macro
- job:
    name: @repo@-pull-request
    description: Build pull requests to the @repo@
    project-type: freestyle
    node: sbt
    logrotate:
        daysToKeep: -1
        numToKeep: 30
        artifactDaysToKeep: 30
        artifactNumToKeep: -1
    properties:
      - prop-macro
    scm:
      - scm-macro:
          branch: ${sha1}
          refspec: +refs/pull/*:refs/remotes/origin/pr/*
          included: ''
          excluded: 'jenkins/.*'
    triggers:
      - pull-request-trigger
    builders:
      - builder-macro:
          task: test
    publishers:
      - pub-macro
    wrappers:
      - ansicolor
- job:
    name: @repo@-jjb
    description: Run Jenkins Job Builder against the jenkins directory
    project-type: freestyle
    logrotate:
        daysToKeep: -1
        numToKeep: 30
        artifactDaysToKeep: 30
        artifactNumToKeep: -1
    properties:
      - prop-macro
    scm:
      - scm-macro:
          branch: "master"
          refspec: +refs/heads/*:refs/remotes/origin/*
          included: 'jenkins/.*'
          excluded: ''
    triggers:
      - main-trigger
    builders:
      - shell: |
               rm -rf /home/cibuild/.cache/jenkins_jobs
               jenkins-jobs update jenkins
      - comment-pr-macro
    publishers:
      - trigger:
          project: @repo@-build
    wrappers:
      - wrapper-macro
