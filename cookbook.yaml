- property:
    name: prop-macro
    properties:
      - github:
          url: https://@url@/@group@/@repo@/
- scm:
    name: scm-macro
    scm:
      - git:
          url: ssh://git@@url@/@group@/@repo@.git
          branches:
            - '{branch}'
          refspec: '{refspec}'
          included-regions:
            - '{included}'
          excluded-regions:
            - '{excluded}'
          wipe-workspace: true
          browser: githubweb
          browser-url: https://@url@/@group@/@repo@/
          git-tool: System Default Git
- trigger:
    name: pull-request-trigger
    triggers:
      - github-pull-request:
          admin-list:
            - carcher
            - gsymons
          org-list:
            - @group@
          cron: '* * * * *'
- trigger:
    name: main-trigger
    triggers:
      - github
      - pollscm: ''
- builder:
    name: builder-macro
    builders:
      - shell: |
               #!/bin/bash --login
               rvm install 1.9.3-p429 --verify-downloads 1
               rvm use --create 1.9.3-p429@di-cookbooks
               bundle install --without dev
               bundle exec rake ci:spec

- builder:
    name: comment-pr-macro
    builders:
      - shell: |
               #!/bin/bash
               set -ex
               group=@group@
               repo=@repo@
               mpr=`git log -1 | grep -oe "Merge pull request #[0-9]*" | { grep -oe [0-9]* || true; }`
               #find out if the pull request has already been commented
               commented=`curl -k -H "Authorization: token @token@" https://@apiUrl@/repos/$group/$repo/issues/$mpr/comments | { grep "$JOB_NAME number [0-9]* integrated pull request" || true; }`
               if [[ -z $commented ]]; then
                 #Comment on pull request the build it was integrated in
                 if [[ -n "$mpr" ]]; then
                   curl -k -H "Authorization: token @token@" -d "{\"body\":\"$JOB_NAME number $BUILD_NUMBER integrated pull request #$mpr.  For details see: $BUILD_URL\"}" -X POST https://@apiUrl@/repos/$group/$repo/issues/$mpr/comments
                 fi
               fi
- wrapper:
    name: wrapper-macro
    wrappers:
      - inject:
          script-content: echo REAL_BRANCH=`git rev-parse HEAD | git branch --contains | grep -E -v '^(\*)'`>branch.prop
      - build-name:
          name: ${PROPFILE,file="branch.prop",property="REAL_BRANCH"}-#$BUILD_NUMBER
- job:
    name: di-cookbooks-@repo@-build
    description: Build @repo@
    project-type: freestyle
    logrotate:
        daysToKeep: -1
        numToKeep: 30
        artifactDaysToKeep: 30
        artifactNumToKeep: -1
    properties:
      - prop-macro
    scm:
      - scm-macro:
          branch: "@branch@"
          refspec: +refs/heads/*:refs/remotes/origin/*
          included: ''
          excluded: 'jenkins/.*'
    triggers:
      - main-trigger
    builders:
      - builder-macro
      - comment-pr-macro
    wrappers:
      - wrapper-macro
- job:
    name: di-cookbooks-@repo@-pull-request
    description: Build pull requests to the @repo@
    project-type: freestyle
    logrotate:
        daysToKeep: -1
        numToKeep: 30
        artifactDaysToKeep: 30
        artifactNumToKeep: -1
    properties:
      - prop-macro
    scm:
      - scm-macro:
          branch: ${sha1}
          refspec: +refs/pull/*:refs/remotes/origin/pr/*
          included: ''
          excluded: 'jenkins/.*'
    triggers:
      - pull-request-trigger
    builders:
      - builder-macro
- job:
    name: di-cookbooks-@repo@-jjb
    description: Run Jenkins Job Builder against the jenkins directory
    project-type: freestyle
    logrotate:
        daysToKeep: -1
        numToKeep: 30
        artifactDaysToKeep: 30
        artifactNumToKeep: -1
    properties:
      - prop-macro
    scm:
      - scm-macro:
          branch: "@branch@"
          refspec: +refs/heads/*:refs/remotes/origin/*
          included: 'jenkins/.*'
          excluded: ''
    triggers:
      - main-trigger
    builders:
      - shell: |
               rm -rf /home/cibuild/.cache/jenkins_jobs
               jenkins-jobs update jenkins
      - comment-pr-macro
    publishers:
      - trigger:
          project: @repo@-build
    wrappers:
      - wrapper-macro
